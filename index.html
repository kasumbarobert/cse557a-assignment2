<html>
<head>
<link rel="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<!-- <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/jq-3.6.0/dt-1.11.4/b-2.2.2/date-1.1.1/r-2.2.9/datatables.min.css"/> -->
<!-- <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/jq-3.6.0/dt-1.11.4/b-2.2.2/date-1.1.1/r-2.2.9/datatables.min.js"></script> -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script src="https://unpkg.com/stopword@1.0.1/dist/stopword.latest.js"></script>
<script src="https://rawgit.com/jasondavies/d3-cloud/master/build/d3.layout.cloud.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-plugins/3.4.0/layer/vector/KML.min.js" integrity="sha512-Lvgr0JRKIMOPpyrZxTpSTk23jmfkzHu9TQmsTS+o7XZnESnjuc62NWauzp/OmkaUjnqGkvFTWbDVs1swMrL6Ug==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://unpkg.com/leaflet-kmz@latest/dist/leaflet-kmz.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>


<style>
    #map {
        width: 900px;
        height: 650px;
      }
    

        div, span {
            padding: 1em;
        }
        .panel { 
    border: 1px solid lightgray;
    margin-top: 0.5px;
}
</style>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body class="container">


    <div id ="controls" class="panel row panel-default mt-3">
        <div id ="employees_div" class="col col-3"> 
            <select class="form-select form-control" aria-label="Default select example" id="employees_list">
                <option value="all">All employees</option>
            </select>
        </div>
        <div id ="employees_div" class="col col-3"> 
            <select class="form-select form-control" aria-label="Default select example" id="departments_list">
                <option>Choose Department</option>
            </select>
        </div>
        <div id ="employees_div" class="col col-3"> 
            <select class="form-select form-control" aria-label="Default select example" id="date">
                    <!-- <option>Choose start Date to visualize</option> -->
                    <option value="1-6-2014">1-6-2014</option>
                    <option value="1-7-2014">1-7-2014</option>
                    <option value="1-8-2014">1-8-2014</option>
                    <option value="1-9-2014">1-9-2014</option>
                    <option value="1-10-2014">1-10-2014</option>
                    <option value="1-11-2014">1-11-2014</option>
                    <option value="1-12-2014">1-12-2014</option>
                    <option value="1-13-2014">1-13-2014</option>
                    <option value="1-14-2014">1-14-2014</option>
                    <option value="1-15-2014">1-15-2014</option>
                    <option value="1-16-2014">1-16-2014</option>
                    <option value="1-17-2014">1-17-2014</option>
                    <option value="1-18-2014">1-18-2014</option>
                    <option value="1-19-2014">1-19-2014</option>

            </select>
        </div>
       
    </div>
    <div class="row">
        <ul class="nav nav-tabs mb-3" id="ex1" role="tablist">
            <li class="nav-item" role="presentation">
                <a
                    class="nav-link active"
                    id="tab-map"
                    data-mdb-toggle="tab"
                    href="#tabs-map"
                    role="tab"
                    aria-controls="tabs-map"
                    aria-selected="true"
                    >Map</a>
            </li>
            <li class="nav-item" role="presentation">
                <a
                    class="nav-link active"
                    id="tab-businesses"
                    data-mdb-toggle="tab"
                    href="#tabs-businesses"
                    role="tab"
                    aria-controls="tabs-businesses"
                    aria-selected="false"
                    >Businesses</a>
            </li>
        </ul>
    </div>

    <div class="tab-content" id="vis-tabs">
        <div
          class="tab-pane fade show active"
          id="tabs-map"
          role="tabpanel"
          aria-labelledby="tab-map"
        >
            <h2>Map </h2>
            <div class ="panel row panel-default">
                <div id ="map" class="col col-12 mt-3">
                
                </div>
            </div>
          
        </div>

        <div class="tab-pane fade" id="tabs-businesses" role="tabpanel" aria-labelledby="tab-businesses">
            <h2>Business Performance Measures</h2>
            <div  class="panel panel-default">
                <div id="bgraph-container" class="panel-body">
                    <span class ="row">
                        <span class ="col-4"><label >Performance Metric:</label></span>
                        <span  class ="col-4">
                            <select id="pmetric" class="form-select form-control" aria-label="Default select example">
                                <option selected value="revenue">Revenue</option>
                                <option value="frequency">Purchase Frequency</option>
                            </select>
                        </span>
                    </span>
                    <h3>Credit Card Histories</h3>
                </div>
            </div>
        </div>
    </div>

    

   
   
    
   


</body>

<script>
    var articles= new Array()
    var location_by_minute = null
    var map  = null
    var all_employees = null
    var map_colors = ["#696969","#a0522d","#006400","#8b0000","#808000","#483d8b","#3cb371","#008080","#4682b4","#9acd32","#00008b","#32cd32","#daa520","#7f007f","#8fbc8f","#9932cc","#ff0000","#00ced1","#ff8c00","#c71585","#00ff00","#e9967a","#dc143c",
    "#00bfff","#0000ff","#adff2f","#da70d6","#ff7f50","#ff00ff","#1e90ff","#db7093","#f0e68c","#ffff54","#dda0dd","#add8e6","#7b68ee","#98fb98","#7fffd4","#ffe4c4","#ffc0cb"]
    $(()=>{

        d3.csv("/data/locations_by_minute.csv").then(function (locationData){
                location_by_minute = locationData
            })

         map = L.map('map', {
            center: [36.06921504029343 , 24.86214637756348],
            zoom: 13.5
        })
        .addLayer(L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        }));

        d3.json("/employees").then(function(employees) {
            all_employees = employees.map(function(emp){
                return emp.CarID
            })
               var options = d3.select("#employees_list").selectAll("option")
               .data(employees).enter().append("option");
               options.text(function(d) {
                return d.FirstName+" "+d.LastName;
                })
                .attr("value", function(d) {
                    return d.CarID;
                });

                // var departments= $.unique(employees.map(function (d) {return ;}));

                // console.log(departments); 
                d3.select("#departments_list").selectAll("option")
                .data([...new Set(d3.map(employees, function(emp){return emp.CurrentEmploymentType;}))])
                .enter()
                .append("option")
                .text(function(d){return d;})
                .attr("value",function(d){return d;});
            }).catch(function(err) {
                    console.log(err)
            })





        
        //map.addLayer(new L.Control.fileLayerLoad("static/Geospatial/Abila.kml"))
        var svg = d3.select(map.getPanes().overlayPane).append("svg"),
        g = svg.append("g").attr("class", "leaflet-zoom-hide");

        

        var kmz = L.kmzLayer().addTo(map);
        //var control = L.control.layers(null, null, { collapsed:false }).addTo(map)
        kmz.on('load', function(e) {
            //control.addLayer(e.layer, e.name);
            
           
        });
        const abila = new L.KML("static/Geospatial/Abila.kml");
        map.addLayer(abila);
        //map.addLayer(new L.KML("static/Geospatial/Abila.kml"))
       kmz.load("static/Geospatial/Kronos Island.kmz")
    
       d3.json("/locations").then(function(locations){
           
            for (let x in locations) {

                L.marker([locations[x].lat , locations[x].long])
                    .bindTooltip(locations[x].name, 
                    {
                        //permanent: true, 
                        direction: 'right',
                        riseOnHover: true
                    }
                ).addTo(map);
            }
       
       })

       d3.select("#employees_list").on("change", function(){
        updateRoutes()
      });
      d3.select("#departments_list").on("change", function(){
        updateRoutes()

      });
    
    
    })
    function updateRoutes(){
        carId = document.getElementById('employees_list').value
        date = document.getElementById('date').value

        if (carId =="all"){
            for (let i in all_employees){
                carId = all_employees[i]
                var carLocations = location_by_minute.filter(function(location){
                    return location.id == carId && (new Date(location.date).setHours(0,0,0,0))==(new Date(date).setHours(0,0,0,0));
                });
                var latlngs = carLocations.map(function(loc){return [loc.lat,loc.long]}); 
                var path = L.polyline(latlngs, {"delay":400,"weight":1,"color":map_colors[carId],"paused":true,"reverse":true}).addTo(map);
            }
        }
        else{
            var carLocations = location_by_minute.filter(function(location){
                return location.id == carId && (new Date(location.date).setHours(0,0,0,0))==(new Date(date).setHours(0,0,0,0));
            });
            var latlngs = carLocations.map(function(loc){return [loc.lat,loc.long]}); 
            var path = L.polyline(latlngs, {"delay":400,"weight":3,"color":map_colors[carId],"paused":true,"reverse":true}).addTo(map);
        }
        
        
    }
    
    </script>
    <script src="script.js"></script>
</html>