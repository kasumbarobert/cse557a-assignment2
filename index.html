<!DOCTYPE html>
<html>
<head>
<link rel="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<!-- <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/jq-3.6.0/dt-1.11.4/b-2.2.2/date-1.1.1/r-2.2.9/datatables.min.css"/> -->
<!-- <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/jq-3.6.0/dt-1.11.4/b-2.2.2/date-1.1.1/r-2.2.9/datatables.min.js"></script> -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script src="https://unpkg.com/stopword@1.0.1/dist/stopword.latest.js"></script>
<script src="https://rawgit.com/jasondavies/d3-cloud/master/build/d3.layout.cloud.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-plugins/3.4.0/layer/vector/KML.min.js" integrity="sha512-Lvgr0JRKIMOPpyrZxTpSTk23jmfkzHu9TQmsTS+o7XZnESnjuc62NWauzp/OmkaUjnqGkvFTWbDVs1swMrL6Ug==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://unpkg.com/leaflet-kmz@latest/dist/leaflet-kmz.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>


<style>
    #map {
        width: 900px;
        height: 600px;
      }
    

        div, span {
            padding: 1em;
        }
        .panel { 
    border: 1px solid lightgray;
    margin-top: 0.5px;
}
</style>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body >
    <div class=" row">
        <div class="col col-3">
            <div id ="controls" class="panel  panel-default">
                <div id ="employees_div"> 
                    <select class="form-select form-control" aria-label="Default select example" id="employees_list">
                        <option value="all">All employees</option>
                    </select>
                </div>
                <div id ="department_div" > 
                    <select class="form-select form-control"  id="departments_list">
                        <option>Choose Department</option>
                    </select>
                </div>
                <div id ="date_div" > 
                    <select class="form-select form-control"  id="date">
                            <!-- <option>Choose start Date to visualize</option> -->
                            <option value="1-6-2014">1-6-2014</option>
                            <option value="1-7-2014">1-7-2014</option>
                            <option value="1-8-2014">1-8-2014</option>
                            <option value="1-9-2014">1-9-2014</option>
                            <option value="1-10-2014">1-10-2014</option>
                            <option value="1-11-2014">1-11-2014</option>
                            <option value="1-12-2014">1-12-2014</option>
                            <option value="1-13-2014">1-13-2014</option>
                            <option value="1-14-2014">1-14-2014</option>
                            <option value="1-15-2014">1-15-2014</option>
                            <option value="1-16-2014">1-16-2014</option>
                            <option value="1-17-2014">1-17-2014</option>
                            <option value="1-18-2014">1-18-2014</option>
                            <option value="1-19-2014">1-19-2014</option>
                    </select>
                </div>
                <div id ="date_div" class="row" > 
                    <div class="col-6" > 
                        <input type="time" class="form-control col-12" id="start_time" min="00" max="23" value="00:00"/>
                    </div>
                    <div class="col-6" > 
                        <input type="time" class="form-control col-12" id="end_time" min="00" max="23" value="23:59"/>
                    </div>
                </div>
               
            </div>
        </div>
        <div class="col col-9">
            <div class="row">
                <ul class="nav nav-tabs mb-3" id="ex1" role="tablist">
                    <li class="nav-item active" role="presentation">
                        <a
                            class="nav-link active"
                            id="tab-map"
                            data-toggle="tab"
                            href="#tabs-map"
                            role="tab"
                            aria-controls="tabs-map"
                            aria-selected="true"
                            >Map</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a
                            class="nav-link "
                            id="tab-businesses"
                            data-toggle="tab"
                            href="#tabs-businesses"
                            role="tab"
                            aria-controls="tabs-businesses"
                            aria-selected="false"
                            >Businesses</a>
                    </li>
                </ul>
            </div>
        
            <div class="tab-content" id="vis-tabs">
                <div
                  class="tab-pane fade show active"
                  id="tabs-map"
                  role="tabpanel"
                  aria-labelledby="tab-map"
                >
                    <div class ="panel row panel-default">
                        <div id ="map" class="col col-12 mt-3">
                        
                        </div>
                    </div>
                  
                </div>
        
                <div class="tab-pane fade" id="tabs-businesses" role="tabpanel" aria-labelledby="tab-businesses">
                    <h2>Business Performance Measures</h2>
                    <div  class="panel panel-default">
                        <span class="row">
                            <span class="col-4"><label>Performance Metric:</label></span>
                            <span class="col-4">
                                <select id="pmetric" class="form-select form-control" aria-label="Default select example">
                                    <option selected="" value="revenue">Revenue</option>
                                    <option value="frequency">Purchase Frequency</option>
                                </select>
                            </span>
                        </span>

                            <h2>Business Performance Measures</h2>
                            <div id="bgraph-container">
                                <h3>Credit Card Histories</h3>
                            </div>

                            <br>
                            
                        <div id="cc-time-info">

                            <span class="row">
                                <span class="col-4"><label>Business:</label></span>
                                <span class="col-4">
                                    <select id="ccmetric-select" class="form-select form-control" >
                                    <option selected value="cc base">Select</option>
                                    <option value="Abila Airport">Abila Airport</option>
                                    <option value="Abila Scrapyard">Abila Scrapyard</option>
                                    <option value="Abila Zacharo">Abila Zacharo</option>
                                    <option value="Ahaggo Museum">Ahaggo Museum</option>
                                    <option value="Albert's Fine Clothing">Albert's Fine Clothing</option>
                                    <option value="Bean There Done That">Bean There Done That</option>
                                    <option value="Brewed Awakenings">Brewed Awakenings</option>
                                    <option value="Carlyle Chemical Inc.">Carlyle Chemical Inc.</option>
                                    <option value="Chostus Hotel">Chostus Hotel</option>
                                    <option value="Coffee Cameleon">Coffee Cameleon</option>
                                    <option value="Coffee Shack">Coffee Shack</option>
                                    <option value="Daily Dealz">Daily Dealz</option>
                                    <option value="Desafio Golf Course">Desafio Golf Course</option>
                                    <option value="Frank's Fuel">Frank's Fuel</option>
                                    <option value="Frydos Autosupply n' More">Frydos Autosupply n' More</option>
                                    <option value="Gelatogalore">Gelatogalore</option>
                                    <option value="General Grocer">General Grocer</option>
                                    <option value="Guy's Gyros">Guy's Gyros</option>
                                    <option value="Hallowed Grounds">Hallowed Grounds</option>
                                    <option value="Hippokampos">Hippokampos</option>
                                    <option value="Jack's Magical Beans">Jack's Magical Beans</option>
                                    <option value="Kalami Kafenion">Kalami Kafenion</option>
                                    <option value="Katerinas Cafe">Katerina's Café</option>
                                    <option value="Kronos Mart">Kronos Mart</option>
                                    <option value="Kronos Pipe and Irrigation">Kronos Pipe and Irrigation</option>
                                    <option value="Maximum Iron and Steel">Maximum Iron and Steel</option>
                                    <option value="Nationwide Refinery">Nationwide Refinery</option>
                                    <option value="Octavio's Office Supplies">Octavio's Office Supplies</option>
                                    <option value="Ouzeri Elian">Ouzeri Elian</option>
                                    <option value="Robert and Sons">Robert and Sons</option>
                                    <option value="Shoppers' Delight">Shoppers' Delight</option>
                                    <option value="Stewart and Sons Fabrication">Stewart and Sons Fabrication</option>
                                    <option value="U-Pump">U-Pump</option>
                                </select>
                                </span>
                            </span>

                            <h2> Aggregate Business Performance (CC) </h2>
                         

                            <div id="cc-time-graph-container" class="creditBarGraph">
                                <h2>Business Performance by CC over time</h2>
                            </div>

                            <div id="tooltip" class="creditTooltip">
                                <h4>CC Tooltip</h4>
                                <p id="cc-name"> Name: </p>
                                <p id="cc-price"> Amount paid: </p>
                                <p id="cc-revenue"> Total spent: </p>
                                <p id="cc-division"> Division: </p>
                                <p id="cc-title">Title: </p>
                            </div>
                            
                        </div>

                            <br>
                            <br>

                        <div id="loyalty-time-container"> 
                            
                            <span class="row">
                                <span class="col-4">
                                    <label>Business:</label>
                                </span>
                                <span class="col-4">
                                    <select id="lometric-select" class="form-select form-control" >
                                    <option selected value="cc base">Select</option>
                                    <option value="Abila Airport">Abila Airport</option>
                                    <option value="Abila Scrapyard">Abila Scrapyard</option>
                                    <option value="Abila Zacharo">Abila Zacharo</option>
                                    <option value="Ahaggo Museum">Ahaggo Museum</option>
                                    <option value="Albert's Fine Clothing">Albert's Fine Clothing</option>
                                    <option value="Bean There Done That">Bean There Done That</option>
                                    <option value="Brewed Awakenings">Brewed Awakenings</option>
                                    <option value="Carlyle Chemical Inc.">Carlyle Chemical Inc.</option>
                                    <option value="Chostus Hotel">Chostus Hotel</option>
                                    <option value="Coffee Cameleon">Coffee Cameleon</option>
                                    <option value="Coffee Shack">Coffee Shack</option>
                                    <option value="Desafio Golf Course">Desafio Golf Course</option>
                                    <option value="Frank's Fuel">Frank's Fuel</option>
                                    <option value="Frydos Autosupply n' More">Frydos Autosupply n' More</option>
                                    <option value="Gelatogalore">Gelatogalore</option>
                                    <option value="General Grocer">General Grocer</option>
                                    <option value="Guy's Gyros">Guy's Gyros</option>
                                    <option value="Hallowed Grounds">Hallowed Grounds</option>
                                    <option value="Hippokampos">Hippokampos</option>
                                    <option value="Jack's Magical Beans">Jack's Magical Beans</option>
                                    <option value="Kalami Kafenion">Kalami Kafenion</option>
                                    <option value="Katerinas Cafe">Katerina's Café</option>
                                    <option value="Kronos Mart">Kronos Mart</option>
                                    <option value="Kronos Pipe and Irrigation">Kronos Pipe and Irrigation</option>
                                    <option value="Maximum Iron and Steel">Maximum Iron and Steel</option>
                                    <option value="Nationwide Refinery">Nationwide Refinery</option>
                                    <option value="Octavio's Office Supplies">Octavio's Office Supplies</option>
                                    <option value="Ouzeri Elian">Ouzeri Elian</option>
                                    <option value="Roberts and Sons">Robert and Sons</option>
                                    <option value="Shoppers' Delight">Shoppers' Delight</option>
                                    <option value="Stewart and Sons Fabrication">Stewart and Sons Fabrication</option>
                                    <option value="U-Pump">U-Pump</option>
                                    </select>
                                </span>
                            </span>

                            <h2> Aggregate Business Performance (Loyalty) </h2>
                            <div id="loyalty-time-graph-container">
                                <h3>Business Performance by Loyalty over time</h3>
                            </div>

                            <div id="loyalty-tooltip" class="loyaltyTooltip">
                                <h4>CC Tooltip</h4>
                                <p id="lo-name"> Name: </p>
                                <p id="lo-price"> Amount paid: </p>
                                <p id="lo-revenue"> Total spent: </p>
                                <p id="lo-division"> Division: </p>
                                <p id="lo-title">Title: </p>
                            </div>
                            

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    var articles= new Array()
    var location_by_minute = null
    var map  = null
    var all_employees_ids = null
    var all_employees = null
    var map_colors = ["#696969","#a0522d","#006400","#8b0000","#808000","#483d8b","#3cb371","#008080","#4682b4","#9acd32","#00008b","#32cd32","#daa520","#7f007f","#8fbc8f","#9932cc","#ff0000","#00ced1","#ff8c00","#c71585","#00ff00","#e9967a","#dc143c",
    "#00bfff","#0000ff","#adff2f","#da70d6","#ff7f50","#ff00ff","#1e90ff","#db7093","#f0e68c","#ffff54","#dda0dd","#add8e6","#7b68ee","#98fb98","#7fffd4","#ffe4c4","#ffc0cb"]
    var all_employees_ids_layer_group = []
    var single_employee_layer_group = []
    var abila_layer_group = null
    var department_employees_layer =[]
    $(()=>{
        
        d3.csv("data/locations_by_minute.csv").then(function (locationData){
                location_by_minute = locationData
            })

         map = L.map('map', {
            center: [36.068421504029343 , 24.86214637756348],
            zoom: 13.5
        })
        .addLayer(L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        }));
        all_employees_ids_layer_group = L.layerGroup()
        single_employee_layer_group = L.layerGroup()
        department_employees_layer = L.layerGroup()

        d3.csv("assignment2/car-assignments.csv").then(function(employees) {
            console.log(employees)
            all_employees_ids = employees.map(function(emp){
                return emp.CarID
            })
            all_employees_ids = all_employees_ids.filter(Boolean)
            all_employees = employees
            var options = d3.select("#employees_list").selectAll("option")
            .data(employees).enter().append("option");
            options.text(function(d) {
                return d.FirstName+" "+d.LastName;
            })
            .attr("value", function(d) {
                return d.CarID;
            });
            d3.select("#departments_list").selectAll("option")
            .data([...new Set(d3.map(employees, function(emp){return emp.CurrentEmploymentType;}))])
            .enter()
            .append("option")
            .text(function(d){return d;})
            .attr("value",function(d){return d;});

            updateRoutes()
            }).catch(function(err) {
                    console.log(err)
            })
        var svg = d3.select(map.getPanes().overlayPane).append("svg"),
        g = svg.append("g").attr("class", "leaflet-zoom-hide");
        abila_layer_group = new L.KML("assignment2/Geospatial/Abila.kml");
        map.addLayer(abila_layer_group);
        
        var kmz = L.kmzLayer().addTo(map);
        kmz.load("assignment2/Geospatial/Kronos Island.kmz")
    
       d3.json("data/business_locations.json").then(function(locations){
           
            for (let x in locations) {

                L.marker([locations[x].lat , locations[x].long])
                    .bindTooltip(locations[x].name, 
                    {
                        //permanent: true, 
                        direction: 'right',
                        riseOnHover: true
                    }
                ).addTo(map);
            }
            abila_layer_group.setStyle({color: '#eeeeee', "weight":0.2})
       
       })

       d3.select("#employees_list").on("change", function(){
        updateRoutes()
      });
      d3.select("#departments_list").on("change", function(){
        displayRoutesFromDept()

      });
      d3.select("#date").on("change", function(){
        updateRoutes()

      });

      d3.select("#start_time").on("change", function(){
        updateRoutes()

      });
      d3.select("#end_time").on("change", function(){
        updateRoutes()

      });
    
     
    })
    function updateRoutes(){
        carId = document.getElementById('employees_list').value
        date = document.getElementById('date').value
        start_time = date+" "+document.getElementById('start_time').value
        end_time = date+" "+document.getElementById('end_time').value
        console.log(start_time, end_time)

        if (carId =="all"){
            displayALlRoutes(start_time, end_time)
            single_employee_layer_group.clearLayers()
            department_employees_layer.clearLayers()
        }
        else{
            displayALlRoutes(start_time, end_time)
            department_employees_layer.clearLayers()
            single_employee_layer_group.clearLayers()
            loc_start_time = new Date(start_time)
            loc_end_time = new Date(end_time)
            var carLocations = location_by_minute.filter(function(location){
                gps_date_time = new Date(location.Timestamp)
                return location.id == carId && (gps_date_time>=loc_start_time && gps_date_time<=loc_end_time);
            });
            
            var latlngs = carLocations.map(function(loc){return [loc.lat,loc.long]}); 
            var path = L.polyline(latlngs, {"delay":400,"weight":3,"color":map_colors[carId],"paused":true,"reverse":true, "id":carId})
            i = carId
            path.bindPopup("<span style='color:"+map_colors[carId]+"'>"+all_employees[i].FirstName +" "+all_employees[i].LastName+"</span>",{
                    direction: 'auto',
                    color:map_colors[carId]
            })
            path.on("mouseover", function(e){
                this.setStyle({ "weight":5})
                map.openPopup(this._popup)
            })
            path.on("mouseout", function(e){
                this.setStyle({ "weight":3})
                map.closePopup()
            })
            path.on("clik", function(e){
                console.log(d3.select("#employees_list").node())
            })
           
            single_employee_layer_group.addLayer( L.circleMarker(latlngs[0],{color:"red",radius:7}))
            single_employee_layer_group.addLayer( L.circleMarker(latlngs[latlngs.length-1],{color:"blue",radius:7}))
            single_employee_layer_group.addLayer(path)
            single_employee_layer_group.addTo(map);
        }
        
        
    }

    function displayRoutesFromDept(){
            department = document.getElementById('departments_list').value
            department_employees_layer.clearLayers()
            single_employee_layer_group.clearLayers()
            date = document.getElementById('date').value
            start_time = date+" "+document.getElementById('start_time').value
            end_time = date+" "+document.getElementById('end_time').value
            loc_start_time = new Date(start_time)
            loc_end_time = new Date(end_time)
            dept_employees = all_employees.filter(function(emp){
               return emp.CurrentEmploymentType==department
            })
            for (let i in dept_employees){
                var carId = dept_employees[i].CarID
                var carLocations = location_by_minute.filter(function(location){
                    gps_date_time = new Date(location.Timestamp)
                    return location.id == carId && (gps_date_time>=loc_start_time && gps_date_time<=loc_end_time);
                });
                var latlngs = carLocations.map(function(loc){return [loc.lat,loc.long]}); 
                var path = L.polyline(latlngs, {"delay":400,"weight":3,"color":map_colors[carId],"paused":true,"reverse":true});
                path.bindPopup("<span style='color:"+map_colors[carId]+"'>"+dept_employees[i].FirstName +" "+dept_employees[i].LastName+"</span>",{
                    direction: 'auto',
                    color:map_colors[carId],
                    riseOnHover: true
                })
                path.on("mouseover", function(e){
                    this.setStyle({ "weight":5})
                })
                path.on("mouseout", function(e){
                    this.setStyle({ "weight":3})
                })
                department_employees_layer.addLayer(path)
            }
            department_employees_layer.addTo(map)
    }
    function displayALlRoutes(start_time, end_time){
            all_employees_ids_layer_group.clearLayers()
            loc_start_time = new Date(start_time)
            loc_end_time = new Date(end_time)
            for (let i in all_employees){
                var carId = all_employees[i].CarID
                var carLocations = location_by_minute.filter(function(location){
                    gps_date_time = new Date(location.Timestamp)
                    return location.id == carId && (gps_date_time>=loc_start_time && gps_date_time<=loc_end_time);
                });
                var latlngs = carLocations.map(function(loc){return [loc.lat,loc.long]}); 
                var path = L.polyline(latlngs, {"delay":400,"weight":0.2,"color":"gray","paused":true,"reverse":true});
                path.bindPopup("<span style='color:gray'>"+all_employees[i].FirstName +" "+all_employees[i].LastName+"</span>",{
                    direction: 'auto',
                    color:map_colors[carId],
                    riseOnHover: true
                })
                path.on("mouseover", function(e){
                    this.setStyle({ "weight":4, color:"black"})
                })
                path.on("mouseout", function(e){
                    this.setStyle({ "weight":1, color:"gray"})
                })
                all_employees_ids_layer_group.addLayer(path)
            }
        all_employees_ids_layer_group.addTo(map);
    }
    
    </script>
    <script src="script.js"></script>
    <script src="agg-data.js"></script>
    <script src="cc-tl-viz.js"></script>
    <script src="loyalty-tl-viz.js"></script>
</html>